<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AnamneseAI | Assistente de Anamnese</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      /* Tema Padrão Antigo (Roxo/Azul) */
      --primary-color: #6a11cb;
      --secondary-color: #2575fc;
      --accent-color-start: #ff416c;
      --accent-color-stop: #ff4b2b;
      --success-color: #28a745;
      --warning-color: #ffc107;
      --info-color: #17a2b8; /* Cor para o botão de reset */
      --danger-color: #dc3545; /* [NOVO] Cor para o botão de apagar */
      --text-color: #e0e0e0;
      --background-color-main: #121212;
      --background-color-card: rgba(30, 30, 30, 0.7);
      --border-color: rgba(255, 255, 255, 0.1);
      --font-family: 'Poppins', sans-serif;
    }

    /* === NOVOS TEMAS === */
    /* NOVO TEMA PRINCIPAL (Verde/Rosa) */
    body.theme-minty-pink {
        --primary-color: #009195;
        --secondary-color: #5ff4ab;
        --accent-color-start: #ff14a9;
        --accent-color-stop: #ff14a9; /* Cor sólida conforme solicitado */
    }
    /* Para o novo tema, botões de ação principais também usam a cor de destaque */
    body.theme-minty-pink #refineButton,
    body.theme-minty-pink #sendButton {
        background: var(--accent-color-start);
    }


    /* Tema Pôr do Sol */
    body.theme-sunset {
        --primary-color: #d35400;
        --secondary-color: #e67e22;
        --accent-color-start: #e74c3c;
        --accent-color-stop: #f1c40f;
    }
    /* Tema Oceano */
    body.theme-ocean {
        --primary-color: #005aa7;
        --secondary-color: #00c6ff;
        --accent-color-start: #ffc107;
        --accent-color-stop: #ff8c00;
        --success-color: #20c997;
        --warning-color: #fd7e14;
    }
    /* Tema Floresta */
    body.theme-forest {
        --primary-color: #134e5e;
        --secondary-color: #71b280;
        --accent-color-start: #a8ff78;
        --accent-color-stop: #78ffd6;
        --success-color: #28a745;
        --text-color: #f0f0f0;
    }
    /* Tema Rosa Escuro */
    body.theme-dark-rose {
        --primary-color: #e83e8c;
        --secondary-color: #6f42c1;
        --accent-color-start: #f54ea2;
        --accent-color-stop: #ff7676;
        --success-color: #17a2b8;
        --border-color: rgba(255, 255, 255, 0.15);
    }


    /* Estilos Gerais */
    body {
      font-family: var(--font-family);
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
      color: var(--text-color);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 24px;
      margin: 0;
      box-sizing: border-box;
      transition: background 0.5s ease;
    }

    .container {
      position: relative; /* Essencial para posicionar elementos filhos */
      width: 100%;
      max-width: 800px;
      background: var(--background-color-card);
      border-radius: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      padding: 32px 40px;
      border: 1px solid var(--border-color);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-sizing: border-box;
    }
    
    /* === [NOVO] ESTILO PARA O TEXTO DE CRÉDITO === */
    .creator-credit {
        position: absolute;
        bottom: 10px; /* Movido para baixo */
        left: 50%; /* Centralizado */
        transform: translateX(-50%); /* Centralizado */
        font-size: 0.75rem; /* 12px */
        color: var(--text-color);
        opacity: 0.6;
        font-weight: 400;
        z-index: 5;
    }
    
    /* === [NOVO/AJUSTADO] CONTAINER PARA CONTROLES SUPERIORES === */
    .top-controls-wrapper {
        display: flex;
        flex-wrap: wrap; /* Permite que os botões quebrem para a linha de baixo em telas muito pequenas */
        justify-content: space-between;
        align-items: flex-start;
        gap: 16px;
        margin-bottom: 16px; /* Adiciona espaço antes do logo */
        position: relative;
        z-index: 10;
    }

    /* === [NOVO] Botão de Engrenagem (Settings) === */
    .settings-drawer {
        position: relative;
    }

    .settings-toggle-btn, .history-btn { /* Estilo unificado */
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid var(--border-color);
        color: var(--text-color);
        padding: 8px 16px;
        border-radius: 20px;
        cursor: pointer;
        font-family: var(--font-family);
        font-weight: 600;
        transition: background 0.3s ease;
        display: flex; /* Para alinhar o SVG com o texto, se houver */
        align-items: center;
        justify-content: center;
        gap: 8px;
    }
    
    /* Apenas para o botão de engrenagem, torná-lo circular */
    .settings-toggle-btn {
        width: 40px; /* Largura e altura iguais para ser circular */
        height: 40px;
        padding: 0; /* Remover padding para que o ícone se ajuste */
        border-radius: 50%; /* Torna-o circular */
        font-size: 1.2rem; /* Tamanho do ícone */
    }
    .settings-toggle-btn svg {
        width: 20px; /* Ajusta o tamanho do SVG dentro do botão */
        height: 20px;
    }


    .settings-toggle-btn:hover, .history-btn:hover { /* Estilo unificado */
        background: rgba(255, 255, 255, 0.2);
    }

    /* === [NOVO] Gaveta de Configurações === */
    .settings-options {
        position: absolute;
        top: calc(100% + 8px);
        left: 0; /* Abre para a esquerda */
        background: var(--background-color-card);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 12px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        min-width: 220px; /* Largura mínima para as opções */
    }

    /* === Controles dentro da Gaveta de Configurações === */
    .settings-item-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-bottom: 10px; /* Espaço entre grupos */
        padding-bottom: 10px;
        border-bottom: 1px solid var(--border-color); /* Separador */
    }

    .settings-item-group:last-child {
        margin-bottom: 0;
        padding-bottom: 0;
        border-bottom: none;
    }

    .settings-item-group label {
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--text-color);
        opacity: 0.9;
        margin-bottom: 4px;
        display: block;
    }

    /* Estilos para o Seletor de Método dentro da gaveta */
    .method-select-btn {
        background: rgba(0, 0, 0, 0.2);
        border: 1px solid var(--border-color);
        color: var(--text-color);
        padding: 8px 12px;
        border-radius: 12px;
        cursor: pointer;
        font-family: var(--font-family);
        font-weight: 500;
        font-size: 0.9rem;
        transition: background 0.3s ease;
        text-align: left;
        width: 100%;
        box-sizing: border-box;
    }
    .method-select-btn:hover {
        background: rgba(255, 255, 255, 0.1);
    }
    .method-options-nested {
        background: rgba(0, 0, 0, 0.1);
        border-radius: 8px;
        padding: 4px;
        margin-top: 8px;
        display: flex;
        flex-direction: column;
        gap: 4px;
    }
    .method-option {
        padding: 8px 12px;
        cursor: pointer;
        border-radius: 6px;
        transition: background-color 0.2s ease;
        font-weight: 400;
        font-size: 0.85rem;
        color: var(--text-color);
    }
    .method-option:hover {
        background-color: rgba(255, 255, 255, 0.08);
    }
    .method-option.active {
        background-color: var(--secondary-color);
        color: #111;
        font-weight: 600;
    }

    /* Estilos para os temas dentro da gaveta */
    .theme-dots-container {
        display: flex;
        flex-wrap: wrap; /* Permite que os dots quebrem a linha */
        gap: 8px;
        margin-top: 8px;
        justify-content: center; /* Centraliza os dots */
    }
    .theme-dot {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        cursor: pointer;
        border: 2px solid rgba(255, 255, 255, 0.5);
        transition: transform 0.2s ease, border-color 0.2s ease;
    }

    .theme-dot:hover {
        transform: scale(1.1);
    }

    .theme-dot.active {
        border-color: #ffffff;
        transform: scale(1.15);
    }

    .theme-dot[data-theme="minty-pink"] { background: linear-gradient(135deg, #009195 0%, #5ff4ab 100%); }
    .theme-dot[data-theme="default"] { background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%); }
    .theme-dot[data-theme="sunset"] { background: linear-gradient(135deg, #d35400 0%, #e67e22 100%); }
    .theme-dot[data-theme="ocean"] { background: linear-gradient(135deg, #005aa7 0%, #00c6ff 100%); }
    .theme-dot[data-theme="forest"] { background: linear-gradient(135deg, #134e5e 0%, #71b280 100%); }
    .theme-dot[data-theme="dark-rose"] { background: linear-gradient(135deg, #e83e8c 0%, #6f42c1 100%); }


    .header {
        text-align: center;
        margin-bottom: 24px; /* Ajustado */
    }

    .header h1 {
      font-size: 2.5rem;
      font-weight: 700;
      letter-spacing: 1px;
      background: -webkit-linear-gradient(45deg, var(--accent-color-start), var(--accent-color-stop));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin: 0;
      display: none; /* Esconde o título de texto */
    }

    /* Novo estilo para a imagem do cabeçalho */
    .header img.main-logo {
        max-width: 250px; /* Ajuste conforme necessário */
        height: auto;
        margin-bottom: 16px; /* Espaçamento abaixo da imagem */
    }


    .header .subtitle {
      font-size: 1rem;
      color: #b0b0b0;
      margin-top: 8px;
    }
    
    /* === [NOVA ESTRUTURA] GAVETA DE CONTEXTO CLÍNICO (ESPECIALIDADES) === */
    .specialty-drawer {
        margin: 16px 0 24px;
        position: relative;
        z-index: 9;
    }
    .specialty-drawer label {
        display: block;
        font-weight: 600;
        font-size: 0.9rem;
        color: var(--text-color);
        opacity: 0.9;
        padding-left: 4px;
        margin-bottom: 8px;
    }
    .specialty-toggle-btn {
        width: 100%;
        box-sizing: border-box;
        background: rgba(0, 0, 0, 0.25);
        border: 1px solid var(--border-color);
        color: var(--text-color);
        padding: 12px 16px;
        border-radius: 12px;
        cursor: pointer;
        font-family: var(--font-family);
        font-weight: 500;
        font-size: 0.95rem;
        transition: all 0.3s ease;
        text-align: left;
    }
    .specialty-toggle-btn:hover {
        border-color: var(--secondary-color);
        box-shadow: 0 0 10px rgba(var(--secondary-color), 0.3);
    }
    .specialty-options {
        position: absolute;
        top: calc(100% + 8px);
        left: 0;
        right: 0;
        background: var(--background-color-card);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 8px;
        display: flex;
        flex-direction: column;
        gap: 4px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        max-height: 250px;
        overflow-y: auto;
    }
    .specialty-option {
        padding: 10px 16px;
        cursor: pointer;
        border-radius: 8px;
        transition: background-color 0.2s ease;
        font-weight: 500;
        color: var(--text-color);
    }
    .specialty-option:hover {
        background-color: rgba(255, 255, 255, 0.1);
    }
    .specialty-option.active {
        background-color: var(--secondary-color);
        color: #111;
        font-weight: 700;
    }


    /* Botões de Controle */
    .recorder-controls {
      text-align: center;
      margin: 24px 0; /* Ajustado */
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap; /* Permite que os botões quebrem a linha */
    }

    .recorder-controls button {
      padding: 12px 24px;
      font-size: 1rem;
      font-weight: 600;
      border-radius: 50px;
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      color: white;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    .recorder-controls button:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
    }

    .recorder-controls button:active {
      transform: translateY(-1px) scale(0.98);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }

    .recorder-controls button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    .recorder-controls button svg {
      width: 22px;
      height: 22px;
    }

    /* === VISUALIZADOR DE ÁUDIO === */
    #audioVisualizer {
      display: block;
      width: 100%;
      height: 100px;
      background-color: rgba(0, 0, 0, 0.2);
      border-radius: 8px;
      margin: 24px auto 16px;
      border: 1px solid var(--border-color);
    }

    /* Estilos específicos dos botões */
    #recordButton {
      background: linear-gradient(45deg, var(--accent-color-start), var(--accent-color-stop));
    }

    /* [NOVO] Estilo para o botão de Reset */
    #resetButton {
      background-color: var(--info-color);
    }

    #pauseButton, #resumeButton {
      background-color: var(--warning-color);
      color: #111;
    }

    #sendButton {
      background-color: var(--success-color);
    }

    .hidden {
      display: none !important;
    }

    /* Status e Loader */
    #status {
      text-align: center;
      font-weight: 500;
      min-height: 24px;
      color: #b0b0b0;
      font-size: 0.9rem;
      transition: color 0.3s ease;
    }

    #timerDisplay {
        text-align: center;
        font-size: 1.8rem;
        font-weight: 600;
        color: var(--text-color);
        margin: 16px 0 -8px 0;
        font-family: 'monospace', sans-serif;
    }

    .loader-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
      margin: 24px 0;
      color: var(--text-color);
    }

    .loader {
      border: 4px solid var(--border-color);
      border-top: 4px solid var(--secondary-color);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    
    #estimationTimer {
        font-size: 0.9rem;
        color: #b0b0b0;
        font-weight: 500;
    }


    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Seções de Saída */
    .output-section {
      margin-top: 24px;
    }

    .output-section h2 {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text-color);
      border-bottom: 2px solid var(--secondary-color);
      padding-bottom: 8px;
      margin-bottom: 16px;
    }

    .output-content {
      background-color: rgba(0, 0, 0, 0.2);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 20px;
      white-space: pre-wrap;
      overflow-wrap: break-word;
      font-family: 'Poppins', sans-serif;
      min-height: 120px;
      line-height: 1.7;
      color: #dcdcdc;
    }
	
	/* === ESTILOS PARA SEÇÃO DE CORREÇÃO === */
    #correctionsTextarea {
        width: 100%;
        box-sizing: border-box;
        height: 120px;
        resize: vertical;
        background-color: rgba(0, 0, 0, 0.25);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 20px;
        color: var(--text-color);
        font-family: var(--font-family);
        font-size: 0.95rem;
        line-height: 1.7;
    }

    #correctionsTextarea:focus {
        outline: none;
        border-color: var(--secondary-color);
        box-shadow: 0 0 10px rgba(var(--secondary-color), 0.3);
    }

    .refine-controls {
        text-align: center;
        margin-top: 16px;
    }

    #refineButton {
        padding: 12px 24px;
        font-size: 1rem;
        font-weight: 600;
        border-radius: 50px;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
        color: white;
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }
    #refineButton:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
    }
    #refineButton:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    /* [NOVO] Estilo para o status de refinamento */
    #refineStatus {
        margin-top: 12px;
        font-size: 0.9rem;
        color: #b0b0b0;
        min-height: 22px; /* Evita que o layout pule */
    }

    .output-content .placeholder {
      color: #777;
      font-style: italic;
    }

    /* === [NOVO] ESTILOS PARA O MODAL DE HISTÓRICO === */
    #historyModal {
        max-width: 600px;
        width: 90%;
        background: var(--background-color-card);
        color: var(--text-color);
        border: 1px solid var(--border-color);
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(10px);
    }
    #historyModal::backdrop {
        background: rgba(0, 0, 0, 0.6);
    }
    #historyModal h2 {
        text-align: center;
        margin-top: 0;
        margin-bottom: 20px;
        color: var(--text-color);
    }
    #historyList {
        max-height: 50vh;
        overflow-y: auto;
        padding-right: 10px; /* Espaço para a barra de rolagem */
    }
    .history-item {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--border-color);
        padding: 12px 16px;
        margin-bottom: 10px;
        border-radius: 10px;
        cursor: pointer;
        transition: background-color 0.2s ease, transform 0.2s ease;
    }
    .history-item:hover {
        background-color: rgba(255, 255, 255, 0.1);
        transform: translateX(4px);
    }
    .history-item-date {
        font-weight: 600;
        display: block;
        margin-bottom: 4px;
    }
    .history-item-details {
        font-size: 0.85rem;
        opacity: 0.8;
    }
    .modal-actions {
        margin-top: 24px;
        display: flex;
        justify-content: space-between;
        gap: 12px;
    }
    .modal-actions button {
        flex-grow: 1;
        padding: 10px 20px;
        font-weight: 600;
        border-radius: 20px;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
        font-family: var(--font-family);
    }
    #clearHistoryButton {
        background-color: var(--danger-color);
        color: white;
    }
    #closeHistoryButton {
        background-color: var(--info-color);
        color: white;
    }

  </style>
</head>
<body class="theme-minty-pink">

  <div class="container">
    
    <div class="top-controls-wrapper">
        <div class="settings-drawer">
            <button class="settings-toggle-btn" title="Configurações">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-gear-fill" viewBox="0 0 16 16">
                    <path d="M9.405 1.05c-.413-1.4-2.397-1.4-2.81 0l-.1.34a1.4 1.4 0 0 1-1.265.95c-1.073.18-1.528 1.24-.942 2.15l.1.159a1.4 1.4 0 0 1-.31 1.275l-.3.458c-1.207 1.465-.338 3.42.942 3.756l.17.042a1.4 1.4 0 0 1 1.056.661l.105.192c.32.749 1.246 1.092 1.96.727l.107-.055a1.4 1.4 0 0 1 1.265 1.01l.099.34c.413 1.4 2.397 1.4 2.81 0l.1-.34a1.4 1.4 0 0 1 1.265-.95c1.073-.18 1.528-1.24.942-2.15l-.1-.159a1.4 1.4 0 0 1 .31-1.275l.3-.458c1.207-1.465.338-3.42-.942-3.756l-.17-.042a1.4 1.4 0 0 1-1.056-.661l-.105-.192c-.32-.749-1.246-1.092-1.96-.727l-.107.055a1.4 1.4 0 0 1-1.265-1.01l-.099-.34zM8 10.93a2.929 2.929 0 1 0 0-5.86 2.929 2.929 0 0 0 0 5.858z"/>
                </svg>
            </button>
            <div class="settings-options hidden">
                <div class="settings-item-group">
                    <label>Método de Anamnese</label>
                    <button class="method-select-btn">Tradicional</button>
                    <div class="method-options-nested hidden">
                        <div class="method-option active" data-method="tradicional">Anamnese Tradicional</div>
                        <div class="method-option" data-method="soap">Prontuário S.O.A.P.</div>
                    </div>
                </div>
                <div class="settings-item-group">
                    <label>Trocar Tema</label>
                    <div class="theme-dots-container">
                        <span class="theme-dot" data-theme="minty-pink" title="Verde & Rosa"></span>
                        <span class="theme-dot" data-theme="default" title="Padrão"></span>
                        <span class="theme-dot" data-theme="sunset" title="Pôr do Sol"></span>
                        <span class="theme-dot" data-theme="ocean" title="Oceano"></span>
                        <span class="theme-dot" data-theme="forest" title="Floresta"></span>
                        <span class="theme-dot" data-theme="dark-rose" title="Rosa Escuro"></span>
                    </div>
                </div>
            </div>
        </div>
        
        <button class="history-btn" id="historyButton">Histórico</button>
    </div>


    <div class="header">
      <img src="https://cdn.shopify.com/s/files/1/0830/2385/5932/files/Untitled_design_6.png?v=1759647321" alt="Sanus IA Logo" class="main-logo">
      <h1 style="display: none;">Sanus IA</h1>      <p class="subtitle">Sua consulta gravada, seu prontuário estruturado em segundos.</p>
    </div>

    <div class="specialty-drawer">
        <label>Contexto Clínico / Fontes</label>
        <button class="specialty-toggle-btn">Nenhuma (Padrão)</button>
        <div class="specialty-options hidden">
        </div>
    </div>

    <div class="recorder-controls">
      <button id="recordButton">
        <svg fill="currentColor" viewBox="0 0 16 16"><path d="M5 3a3 3 0 0 1 6 0v5a3 3 0 0 1-6 0V3z"></path><path d="M3.5 6.5A.5.5 0 0 1 4 7v1a4 4 0 0 0 8 0V7a.5.5 0 0 1 1 0v1a5 5 0 0 1-4.5 4.975V15h3a.5.5 0 0 1 0 1h-7a.5.5 0 0 1 0-1h3v-2.025A5 5 0 0 1 3 8V7a.5.5 0 0 1 .5-.5z"></path></svg>
        <span>Gravar Consulta</span>
      </button>

      <button id="resetButton" class="hidden">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-clockwise" viewBox="0 0 16 16">
            <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
            <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
        </svg>
        <span>Nova Consulta (Reset)</span>
      </button>

      <button id="pauseButton" class="hidden">
       <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pause-fill" viewBox="0 0 16 16"><path d="M5.5 3.5A1.5 1.5 0 0 1 7 5v6a1.5 1.5 0 0 1-3 0V5a1.5 1.5 0 0 1 1.5-1.5zm5 0A1.5 1.5 0 0 1 12 5v6a1.5 1.5 0 0 1-3 0V5a1.5 1.5 0 0 1 1.5-1.5z"/></svg>
        <span>Pausar</span>
      </button>
      <button id="resumeButton" class="hidden">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-play-fill" viewBox="0 0 16 16"><path d="m11.596 8.697-6.363 3.692c-.54.313-1.233-.066-1.233-.697V4.308c0-.63.692-1.01 1.233-.696l6.363 3.692a.802.802 0 0 1 0 1.393z"/></svg>
        <span>Retomar</span>
      </button>
      <button id="sendButton" class="hidden">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" class="bi bi-send-fill"><path d="M15.964.686a.5.5 0 0 0-.65-.65L.767 5.855H.766l-.452.18a.5.5 0 0 0-.082.887l.41.26.001.002 4.995 3.178 3.178 4.995.002.002.26.41a.5.5 0 0 0 .886-.083l6-15Zm-1.833 1.89L6.637 10.07l-.215-.338a.5.5 0 0 0-.154-.154l-.338-.215 7.494-7.494 1.178-.471-.47 1.178Z"/></svg>
        <span>Analisar Gravação</span>
      </button>
    </div>

    <canvas id="audioVisualizer" width="720" height="100" class="hidden"></canvas>

    <p id="timerDisplay" class="hidden">00:00</p>

    <p id="status">Clique no botão "Gravar Consulta" para iniciar.</p>

    <div id="loader" class="loader-wrapper hidden">
      <div class="loader"></div>
      <p>Analisando o áudio com a IA...</p>
      <p id="estimationTimer"></p>
    </div>

    <div class="output-section">
      <h2>Transcrição da Consulta</h2>
      <div id="transcription" class="output-content">
        <span class="placeholder">A transcrição da conversa aparecerá aqui...</span>
      </div>
    </div>

    <div id="refineSection" class="output-section hidden">
        <h2>Correções e Adições Manuais</h2>
        <textarea id="correctionsTextarea" placeholder="Se a transcrição contiver erros, digite as correções ou informações adicionais aqui... Por exemplo: 'O paciente mencionou febre de 38.5 graus, não 37.5.'"></textarea>
        <div class="refine-controls">
            <button id="refineButton">Refazer Prontuário com Correções</button>
            <p id="refineStatus"></p>
        </div>
    </div>


    <div class="output-section">
      <h2 id="anamnesisTitle">Prontuário / Anamnese Estruturada</h2>
      <div id="anamnesis" class="output-content">
        <span class="placeholder">A anamnese formatada aparecerá aqui...</span>
      </div>
    </div>

    <div id="examsSection" class="output-section hidden">
      <h2>Sugestão de exames laboratoriais e de imagem</h2>
      <div id="examsSuggestions" class="output-content">
        <span class="placeholder">As sugestões de exames baseadas em evidências aparecerão aqui...</span>
      </div>
    </div>

    <div id="prescriptionSection" class="output-section hidden">
      <h2>Sugestão de prescrição de medicamento</h2>
      <div id="prescriptionSuggestions" class="output-content">
        <span class="placeholder">As sugestões de prescrição baseadas em evidências aparecerão aqui...</span>
      </div>
    </div>

    <div id="improvementSection" class="output-section hidden">
      <h2>Pontos a Melhorar/Acrescentar</h2>
      <div id="improvements" class="output-content">
        <span class="placeholder">Sugestões para aprimoramento da consulta aparecerão aqui...</span>
      </div>
    </div>

    <div class="creator-credit"><strong>Feito por:</strong> João Victor Leão </div>
  </div>
  
  <dialog id="historyModal">
      <h2>Histórico de Consultas</h2>
      <div id="historyList">
          </div>
      <div class="modal-actions">
          <button id="clearHistoryButton">Apagar Histórico</button>
          <button id="closeHistoryButton">Fechar</button>
      </div>
  </dialog>


  <script>
  (function(){
    // === CONFIGURAÇÃO (NÃO ALTERADA) ===
    const GEMINI_API_KEY = 'AIzaSyAPfkx1oy28ZG8U3jfTdGuCENLhb6tG_DQ';
    const MODEL = 'gemini-2.5-flash';
    const ENDPOINT = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${GEMINI_API_KEY}`;
    const VELOCIDADE_ROLAGEM = 4;
    const CONSULTATION_HISTORY_KEY = 'anamnesis_history'; // [NOVO] Chave para o localStorage

    // === ELEMENTOS DA PÁGINA ===
    const recordButton = document.getElementById('recordButton');
    const pauseButton = document.getElementById('pauseButton');
    const resumeButton = document.getElementById('resumeButton');
    const sendButton = document.getElementById('sendButton');
    const resetButton = document.getElementById('resetButton');
    const statusEl = document.getElementById('status');
    const transcriptionEl = document.getElementById('transcription');
    const anamnesisEl = document.getElementById('anamnesis');
    const loader = document.getElementById('loader');
    const visualizerCanvas = document.getElementById('audioVisualizer');
    const canvasCtx = visualizerCanvas.getContext('2d');
    const timerDisplayEl = document.getElementById('timerDisplay');
    const estimationTimerEl = document.getElementById('estimationTimer');
    const refineSection = document.getElementById('refineSection');
    const correctionsTextarea = document.getElementById('correctionsTextarea');
    const refineButton = document.getElementById('refineButton');
    const refineStatusEl = document.getElementById('refineStatus');
    const anamnesisTitleEl = document.getElementById('anamnesisTitle');
    const improvementSection = document.getElementById('improvementSection');
    const improvementsEl = document.getElementById('improvements');
    const examsSection = document.getElementById('examsSection');
    const examsSuggestionsEl = document.getElementById('examsSuggestions');
    const prescriptionSection = document.getElementById('prescriptionSection');
    const prescriptionSuggestionsEl = document.getElementById('prescriptionSuggestions');
    // [NOVO] Elementos do Histórico
    const historyButton = document.getElementById('historyButton');
    const historyModal = document.getElementById('historyModal');
    const historyListEl = document.getElementById('historyList');
    const closeHistoryButton = document.getElementById('closeHistoryButton');
    const clearHistoryButton = document.getElementById('clearHistoryButton');


    // === VARIÁVEIS DE ESTADO ===
    let isRecording = false;
    let isPaused = false;
    let isConsultationComplete = false;
    let mediaRecorder;
    let audioChunks = [];
    let audioContext;
    let analyser;
    let animationFrameId;
    let dataArray;
    let bufferLength;
    let timerInterval = null;
    let startTime = 0;
    let accumulatedTime = 0;
    let estimationInterval = null;
    let estimatedProcessTime = 0;
    let processingStartTime = 0;
    let originalTranscriptionText = '';
    let anamnesisMethod = 'tradicional';


    // === LÓGICA DE TEMAS ===
    const settingsDrawer = document.querySelector('.settings-drawer');
    const settingsToggleButton = document.querySelector('.settings-toggle-btn');
    const settingsOptions = document.querySelector('.settings-options');
    const themeDotsContainer = settingsOptions.querySelector('.theme-dots-container');
    const themeDots = themeDotsContainer.querySelectorAll('.theme-dot');
    const bodyEl = document.body;

    function applyTheme(themeName) {
        bodyEl.className = '';
        if (themeName !== 'default') {
            bodyEl.classList.add(`theme-${themeName}`);
        }
        if (themeName === 'minty-pink') {
            bodyEl.classList.add('theme-minty-pink');
        }

        themeDots.forEach(dot => {
            dot.classList.remove('active');
            if (dot.dataset.theme === themeName) {
                dot.classList.add('active');
            }
        });
        localStorage.setItem('anamnesis_theme', themeName);
    }
    
    // Toggle para abrir/fechar a gaveta de configurações
    settingsToggleButton.addEventListener('click', (e) => {
        e.stopPropagation(); // Impede que o clique se propague para o document e feche imediatamente
        settingsOptions.classList.toggle('hidden');
    });

    themeDotsContainer.addEventListener('click', (e) => {
        if (e.target.classList.contains('theme-dot')) {
            applyTheme(e.target.dataset.theme);
            // Manter a gaveta aberta após trocar o tema para permitir outras configs
        }
    });
    
    // === LÓGICA DE MÉTODO DE ANAMNESE (MOVIDO PARA DENTRO DA GAVETA) ===
    const methodSelectBtn = settingsOptions.querySelector('.method-select-btn');
    const methodOptionsNested = settingsOptions.querySelector('.method-options-nested');
    const methodOptions = methodOptionsNested.querySelectorAll('.method-option');

    function applyMethod(method) {
        anamnesisMethod = method;
        methodOptions.forEach(opt => {
            opt.classList.toggle('active', opt.dataset.method === method);
        });

        if (method === 'tradicional') {
            methodSelectBtn.textContent = 'Tradicional';
            anamnesisTitleEl.textContent = 'Prontuário / Anamnese Estruturada';
        } else if (method === 'soap') {
            methodSelectBtn.textContent = 'S.O.A.P.';
            anamnesisTitleEl.textContent = 'Prontuário Estruturado (S.O.A.P.)';
        }
        localStorage.setItem('anamnesis_method', method);
    }
    
    methodSelectBtn.addEventListener('click', (e) => {
        e.stopPropagation(); // Não fecha a gaveta de settings
        methodOptionsNested.classList.toggle('hidden');
    });

    methodOptionsNested.addEventListener('click', (e) => {
        e.stopPropagation(); // Não fecha a gaveta de settings
        const targetOption = e.target.closest('.method-option');
        if (targetOption) {
            applyMethod(targetOption.dataset.method);
            methodOptionsNested.classList.add('hidden'); // Fecha apenas as opções de método
        }
    });

    // === LÓGICA DO CONTEXTO CLÍNICO (ESPECIALIDADES) ===
    const specialtyDrawer = document.querySelector('.specialty-drawer');
    const specialtyToggleButton = document.querySelector('.specialty-toggle-btn');
    const specialtyOptionsContainer = document.querySelector('.specialty-options');

    const specialtyPresets = {
        'none': {
            displayName: 'Nenhuma (Padrão)',
            sources: []
        },
        'mfc': {
            displayName: 'Medicina de Família e Comunidade',
            sources: [
                'https://bvsms.saude.gov.br/bvs/publicacoes/manual_tecnico_controle_tuberculose_cab6.pdf',
                'https://bvsms.saude.gov.br/bvs/publicacoes/violencia_intrafamiliar_cab8.pdf',
                'https://bvsms.saude.gov.br/bvs/publicacoes/dermatologia_atencao_basica_saude_cab9.pdf',
                'https://bvsms.saude.gov.br/bvs/publicacoes/guia_controle_hanseniase_cab10.pdf',
                'https://bvsms.saude.gov.br/bvs/publicacoes/controle_canceres_colo_utero_2013.pdf',
                'https://bvsms.saude.gov.br/bvs/publicacoes/abcad14.pdf',
                'https://bvsms.saude.gov.br/bvs/publicacoes/saude_bucal.pdf',
                'https://www.gov.br/saude/pt-br/centrais-de-conteudo/publicacoes/svsa/atencao-basica/cadernos-de-atencao-basica-18.pdf',
                'https://bvsms.saude.gov.br/bvs/publicacoes/abcad19.pdf',
                'https://bvsms.saude.gov.br/bvs/publicacoes/cadernos_atencao_basica_carencias_micronutrientes.pdf',
                'https://bvsms.saude.gov.br/bvs/publicacoes/cab_n21_vigilancia_saude_2ed_p1.pdf',
                'https://bvsms.saude.gov.br/bvs/publicacoes/vigilancia_saude_zoonoses_p1.pdf',
                'https://bvsms.saude.gov.br/bvs/publicacoes/saude_crianca_aleitamento_materno_cab23.pdf',
                'https://bvsms.saude.gov.br/bvs/publicacoes/cadernos_atencao_basica_24.pdf',
                'https://bvsms.saude.gov.br/bvs/publicacoes/doencas_respiratorias_cronicas.pdf',
                'https://bvsms.saude.gov.br/bvs/publicacoes/saude_sexual_saude_reprodutiva.pdf',
                'https://bvsms.saude.gov.br/bvs/publicacoes/caderno_atencao_basica_diretrizes_nasf.pdf',
                'https://bvsms.saude.gov.br/bvs/publicacoes/acolhimento_demanda_espontanea_cab28v1.pdf',
                'https://bvsms.saude.gov.br/bvs/publicacoes/caderno_atencao_primaria_29_rastreamento.pdf',
                'https://biblioteca.cofen.gov.br/wp-content/uploads/2016/07/Caderno-de-aten%C3%A7%C3%A3o-prim%C3%A1ria-n30-procedimentos.pdf',
                'https://bvsms.saude.gov.br/bvs/publicacoes/praticas_integrativas_complementares_plantas_medicinais_cab31.pdf',
                'https://bvsms.saude.gov.br/bvs/publicacoes/cadernos_atencao_basica_32_prenatal.pdf',
                'https://bvsms.saude.gov.br/bvs/publicacoes/saude_crianca_crescimento_desenvolvimento.pdf',
                'https://bvsms.saude.gov.br/bvs/publicacoes/cadernos_atencao_basica_34_saude_mental.pdf',
                'https://bvsms.saude.gov.br/bvs/publicacoes/estrategias_cuidado_pessoa_doenca_cronica_cab35.pdf',
                'https://bvsms.saude.gov.br/bvs/publicacoes/estrategias_cuidado_pessoa_diabetes_mellitus_cab36.pdf',
                'https://bvsms.saude.gov.br/bvs/publicacoes/hipertensao_arterial_sistemica_cab37.pdf',
                'https://bvsms.saude.gov.br/bvs/publicacoes/estrategias_cuidado_doenca_cronica_obesidade_cab38.pdf',
                'https://bvsms.saude.gov.br/bvs/publicacoes/nucleo_apoio_saude_familia_cab39.pdf',
                'https://biblioteca.cofen.gov.br/wp-content/uploads/2017/01/Estrat%C3%A9gias-para-o-cuidado-da-pessoa-com-doen%C3%A7a-cr%C3%B4nica-o-cuidado-da-pessoa-tabagista.pdf',
                'https://bvsms.saude.gov.br/bvs/publicacoes/saude_trabalhador_trabalhadora.pdf'
            ]
        },
        'clinica_medica': {
            displayName: 'Clínica Médica (Hospitalar)',
            sources: []
        },
        'cardiologia': {
            displayName: 'Cardiologia',
            sources: []
        },
        'endocrinologia': {
            displayName: 'Endocrinologia',
            sources: []
        },
        'pediatria': {
            displayName: 'Pediatria',
            sources: []
        }
    };
    let selectedSpecialty = 'none';

    function applySpecialty(specialtyKey) {
        if (!specialtyPresets[specialtyKey]) return;
        selectedSpecialty = specialtyKey;
        const specialty = specialtyPresets[specialtyKey];
        specialtyToggleButton.textContent = specialty.displayName;
        const options = specialtyOptionsContainer.querySelectorAll('.specialty-option');
        options.forEach(opt => {
            opt.classList.toggle('active', opt.dataset.specialty === specialtyKey);
        });
        localStorage.setItem('anamnesis_specialty', specialtyKey);
    }

    function populateSpecialties() {
        specialtyOptionsContainer.innerHTML = '';
        for (const key in specialtyPresets) {
            const option = document.createElement('div');
            option.className = 'specialty-option';
            option.dataset.specialty = key;
            option.textContent = specialtyPresets[key].displayName;
            specialtyOptionsContainer.appendChild(option);
        }
    }

    specialtyToggleButton.addEventListener('click', (e) => {
        e.stopPropagation(); // Impede fechamento de outras gavetas
        specialtyOptionsContainer.classList.toggle('hidden');
    });
    specialtyOptionsContainer.addEventListener('click', (e) => {
        const targetOption = e.target.closest('.specialty-option');
        if (targetOption) {
            applySpecialty(targetOption.dataset.specialty);
            specialtyOptionsContainer.classList.add('hidden');
        }
    });

    // Evento unificado para fechar gavetas ao clicar fora
    document.addEventListener('click', (e) => {
        // Fecha a gaveta de configurações
        if (!settingsDrawer.contains(e.target) && !settingsOptions.classList.contains('hidden')) {
            settingsOptions.classList.add('hidden');
        }
        // Fecha as opções de método aninhadas, se abertas
        if (!methodSelectBtn.contains(e.target) && !methodOptionsNested.classList.contains('hidden')) {
            methodOptionsNested.classList.add('hidden');
        }
        // Fecha a gaveta de especialidades
        if (!specialtyDrawer.contains(e.target) && !specialtyOptionsContainer.classList.contains('hidden')) {
            specialtyOptionsContainer.classList.add('hidden');
        }
    });

    document.addEventListener('DOMContentLoaded', () => {
        const savedTheme = localStorage.getItem('anamnesis_theme') || 'minty-pink';
        applyTheme(savedTheme);
        const savedMethod = localStorage.getItem('anamnesis_method') || 'tradicional';
        applyMethod(savedMethod);
        
        populateSpecialties();
        const savedSpecialty = localStorage.getItem('anamnesis_specialty') || 'none';
        applySpecialty(savedSpecialty);
        
        // [NOVO] Adiciona listeners de eventos para o modal de histórico
        historyButton.addEventListener('click', displayHistory);
        closeHistoryButton.addEventListener('click', () => historyModal.close());
        clearHistoryButton.addEventListener('click', clearHistory);
        historyListEl.addEventListener('click', loadConsultationFromHistory);
    });
    
    // === [NOVO] FUNÇÕES DE HISTÓRICO ===
    function getHistory() {
        const historyJson = localStorage.getItem(CONSULTATION_HISTORY_KEY);
        return historyJson ? JSON.parse(historyJson) : [];
    }

    function saveConsultationToHistory() {
        // Só salva se a consulta tiver sido completada e tiver transcrição
        const hasPlaceholder = transcriptionEl.querySelector('.placeholder');
        if (!isConsultationComplete || hasPlaceholder || !transcriptionEl.textContent.trim()) {
            return;
        }

        const history = getHistory();
        const newConsultation = {
            id: Date.now(),
            method: anamnesisMethod,
            specialty: selectedSpecialty,
            duration: timerDisplayEl.textContent,
            transcription: transcriptionEl.innerHTML,
            anamnesis: anamnesisEl.innerHTML,
            exams: examsSuggestionsEl.innerHTML,
            prescription: prescriptionSuggestionsEl.innerHTML,
            improvements: improvementsEl.innerHTML
        };

        history.unshift(newConsultation); // Adiciona no início (mais recente)
        localStorage.setItem(CONSULTATION_HISTORY_KEY, JSON.stringify(history));
    }

    function displayHistory() {
        const history = getHistory();
        historyListEl.innerHTML = ''; // Limpa a lista atual
        if (history.length === 0) {
            historyListEl.innerHTML = '<p style="text-align: center;">Nenhuma consulta salva ainda.</p>';
        } else {
            history.forEach(consultation => {
                const item = document.createElement('div');
                item.className = 'history-item';
                item.dataset.id = consultation.id;
                
                const date = new Date(consultation.id).toLocaleString('pt-BR');
                const methodName = consultation.method === 'soap' ? 'S.O.A.P.' : 'Tradicional';
                const specialtyName = specialtyPresets[consultation.specialty]?.displayName || 'Padrão';

                item.innerHTML = `
                    <span class="history-item-date">${date}</span>
                    <span class="history-item-details">
                        Duração: ${consultation.duration} | Método: ${methodName} | Contexto: ${specialtyName}
                    </span>
                `;
                historyListEl.appendChild(item);
            });
        }
        historyModal.showModal();
    }

    function loadConsultationFromHistory(e) {
        const item = e.target.closest('.history-item');
        if (!item) return;

        const history = getHistory();
        const consultationId = parseInt(item.dataset.id, 10);
        const consultation = history.find(c => c.id === consultationId);

        if (consultation) {
            resetApp(false); // Reseta a UI sem salvar a consulta atual (que já é uma do histórico)

            transcriptionEl.innerHTML = consultation.transcription;
            anamnesisEl.innerHTML = consultation.anamnesis;
            examsSuggestionsEl.innerHTML = consultation.exams;
            prescriptionSuggestionsEl.innerHTML = consultation.prescription;
            improvementsEl.innerHTML = consultation.improvements;
            timerDisplayEl.textContent = consultation.duration;
            originalTranscriptionText = transcriptionEl.textContent; // Para permitir refinamento

            applyMethod(consultation.method);
            applySpecialty(consultation.specialty);

            // Mostra as seções relevantes
            refineSection.classList.remove('hidden');
            improvementSection.classList.remove('hidden');
            examsSection.classList.remove('hidden');
            prescriptionSection.classList.remove('hidden');
            timerDisplayEl.classList.remove('hidden');

            isConsultationComplete = true;
            statusEl.textContent = `Consulta de ${new Date(consultation.id).toLocaleString('pt-BR')} carregada.`;
            updateButtonsUI();
            historyModal.close();
        }
    }

    function clearHistory() {
        if (confirm('Tem certeza que deseja apagar permanentemente todo o histórico de consultas? Esta ação não pode ser desfeita.')) {
            localStorage.removeItem(CONSULTATION_HISTORY_KEY);
            displayHistory(); // Atualiza a exibição do modal (agora vazio)
        }
    }


    // === FUNÇÕES DO CONTADOR DE GRAVAÇÃO ===
    function formatTime(totalSeconds) {
        const minutes = Math.floor(totalSeconds / 60).toString().padStart(2, '0');
        const seconds = (totalSeconds % 60).toString().padStart(2, '0');
        return `${minutes}:${seconds}`;
    }
    function updateTimer() {
        const elapsedTimeSinceStart = Date.now() - startTime;
        const totalElapsedTime = accumulatedTime + elapsedTimeSinceStart;
        const totalSeconds = Math.floor(totalElapsedTime / 1000);
        timerDisplayEl.textContent = formatTime(totalSeconds);
    }
    function startTimer() {
        timerDisplayEl.classList.remove('hidden');
        startTime = Date.now();
        if (timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(updateTimer, 1000);
    }
    function stopTimer() {
        clearInterval(timerInterval);
        timerInterval = null;
    }

    // === FUNÇÕES DE VISUALIZAÇÃO DE ÁUDIO ===
    function visualize(stream) {
        if (!audioContext || audioContext.state === 'closed') audioContext = new AudioContext();
        const source = audioContext.createMediaStreamSource(stream);
        analyser = audioContext.createAnalyser();
        analyser.fftSize = 256;
        bufferLength = analyser.frequencyBinCount;
        dataArray = new Uint8Array(bufferLength);
        source.connect(analyser);
        const bodyStyles = window.getComputedStyle(bodyEl);
        const bgColor = bodyStyles.getPropertyValue('--background-color-card');
        canvasCtx.fillStyle = bgColor;
        canvasCtx.fillRect(0, 0, visualizerCanvas.width, visualizerCanvas.height);
        visualizerCanvas.classList.remove('hidden');
        drawWave();
    }
    function drawWave() {
        animationFrameId = requestAnimationFrame(drawWave);
        canvasCtx.drawImage(visualizerCanvas, -VELOCIDADE_ROLAGEM, 0);
        analyser.getByteTimeDomainData(dataArray);
        let min = 128, max = 128;
        for (let i = 0; i < bufferLength; i++) {
            if (dataArray[i] < min) min = dataArray[i];
            if (dataArray[i] > max) max = dataArray[i];
        }
        const minVal = (min / 255) * visualizerCanvas.height;
        const maxVal = (max / 255) * visualizerCanvas.height;
        const amplitude = Math.max(1, maxVal - minVal);
        const bodyStyles = window.getComputedStyle(bodyEl);
        const bgColor = bodyStyles.getPropertyValue('--background-color-card');
        const waveColor = bodyStyles.getPropertyValue('--secondary-color');
        canvasCtx.fillStyle = bgColor;
        canvasCtx.fillRect(visualizerCanvas.width - VELOCIDADE_ROLAGEM, 0, VELOCIDADE_ROLAGEM, visualizerCanvas.height);
        canvasCtx.fillStyle = waveColor.trim();
        canvasCtx.fillRect(visualizerCanvas.width - VELOCIDADE_ROLAGEM, minVal, VELOCIDADE_ROLAGEM, amplitude);
    }
    
    // === FUNÇÕES DO CONTADOR DE ESTIMATIVA ===
    function startEstimationCountdown(duration) {
      if (estimationInterval) clearInterval(estimationInterval);
      let timeLeft = duration;
      function update() {
        if (timeLeft <= 0) {
          estimationTimerEl.textContent = "A finalização pode levar mais alguns instantes...";
          clearInterval(estimationInterval);
        } else {
          estimationTimerEl.textContent = `Tempo estimado restante: ~${timeLeft} segundos...`;
          timeLeft--;
        }
      }
      update();  
      estimationInterval = setInterval(update, 1000);
    }
    function stopEstimationCountdown() {
      clearInterval(estimationInterval);
      estimationInterval = null;
      estimationTimerEl.textContent = '';
    }

    // === LÓGICA PRINCIPAL DE GRAVAÇÃO E CONTROLES ===
    recordButton.addEventListener('click', startRecording);
    pauseButton.addEventListener('click', pauseRecording);
    resumeButton.addEventListener('click', resumeRecording);
    sendButton.addEventListener('click', stopAndSend);
    refineButton.addEventListener('click', handleRefinement);
    resetButton.addEventListener('click', () => resetApp(true)); // [MODIFICADO] Passa 'true' para indicar que deve salvar

    // [FUNÇÃO MODIFICADA] para resetar o estado da aplicação
    function resetApp(saveCurrent = false) {
        if (saveCurrent) {
            saveConsultationToHistory();
        }

        isRecording = false;
        isPaused = false;
        isConsultationComplete = false;
        audioChunks = [];
        originalTranscriptionText = '';
        if (timerInterval) stopTimer();
        accumulatedTime = 0;

        // Limpa todas as saídas e restaura placeholders
        const placeholderTranscription = '<span class="placeholder">A transcrição da conversa aparecerá aqui...</span>';
        const placeholderAnamnesis = '<span class="placeholder">A anamnese formatada aparecerá aqui...</span>';
        const placeholderExams = '<span class="placeholder">As sugestões de exames baseadas em evidências aparecerão aqui...</span>';
        const placeholderPrescription = '<span class="placeholder">As sugestões de prescrição baseadas em evidências aparecerão aqui...</span>';
        const placeholderImprovements = '<span class="placeholder">Sugestões para aprimoramento da consulta aparecerão aqui...</span>';

        transcriptionEl.innerHTML = placeholderTranscription;
        anamnesisEl.innerHTML = placeholderAnamnesis;
        examsSuggestionsEl.innerHTML = placeholderExams;
        prescriptionSuggestionsEl.innerHTML = placeholderPrescription;
        improvementsEl.innerHTML = placeholderImprovements;
        
        // Esconde seções
        refineSection.classList.add('hidden');
        improvementSection.classList.add('hidden');
        examsSection.classList.add('hidden');
        prescriptionSection.classList.add('hidden');
        timerDisplayEl.classList.add('hidden');
        
        // Reseta status
        statusEl.textContent = 'Clique no botão "Gravar Consulta" para iniciar.';
        correctionsTextarea.value = '';
        refineStatusEl.textContent = '';

        // Atualiza a UI dos botões para o estado inicial
        updateButtonsUI();
    }


    async function startRecording() {
      // Se não for uma continuação, limpa tudo.
      if (!isConsultationComplete) {
        resetApp(false); // Usa a função de reset para garantir um estado limpo
      } else {
        // Se for continuação, apenas prepara para nova gravação sem limpar a tela
        audioChunks = [];
        statusEl.textContent = 'Gravando áudio adicional para complementar a consulta...';
      }

      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        visualize(stream);
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.ondataavailable = event => audioChunks.push(event.data);
        mediaRecorder.onstop = processAudio;
        
        // Zera o timer para a nova gravação
        accumulatedTime = 0;  
        startTimer();
        
        mediaRecorder.start();
        isRecording = true;
        updateButtonsUI();
        if (!isConsultationComplete) {
          statusEl.textContent = 'Gravando... Fale agora.';
        }
      } catch (err) {
        console.error("Erro ao acessar o microfone:", err);
        statusEl.textContent = 'Erro! Não foi possível acessar o microfone. Verifique as permissões.';
      }
    }
    function pauseRecording() {
        if (!mediaRecorder || mediaRecorder.state !== 'recording') return;
        mediaRecorder.pause();
        cancelAnimationFrame(animationFrameId);
        stopTimer();
        accumulatedTime += Date.now() - startTime;
        isPaused = true;
        updateButtonsUI();
        statusEl.textContent = 'Gravação pausada.';
    }
    function resumeRecording() {
        if (!mediaRecorder || mediaRecorder.state !== 'paused') return;
        mediaRecorder.resume();
        startTimer();
        isPaused = false;
        drawWave();
        updateButtonsUI();
        statusEl.textContent = 'Gravando...';
    }
    function stopAndSend() {
      if (mediaRecorder && isRecording) {
            stopTimer();
            if (!isPaused) accumulatedTime += Date.now() - startTime;
            const totalDurationSeconds = Math.floor(accumulatedTime / 1000);
            const formattedTime = formatTime(totalDurationSeconds);
            timerDisplayEl.textContent = formattedTime;
            mediaRecorder.stop();
            cancelAnimationFrame(animationFrameId);
            visualizerCanvas.classList.add('hidden');
            if (audioContext && audioContext.state !== 'closed') audioContext.close();
            if (mediaRecorder.stream) mediaRecorder.stream.getTracks().forEach(track => track.stop());
            isRecording = false;
            isPaused = false;
            updateButtonsUI();
            let lowerBound, upperBound;
            if (totalDurationSeconds < 15) {
                lowerBound = 5;
                upperBound = 10;
            } else {
                lowerBound = Math.max(5, Math.ceil(totalDurationSeconds * 0.20));
                upperBound = Math.max(8, Math.ceil(totalDurationSeconds * 0.35));
            }
            estimatedProcessTime = Math.ceil((lowerBound + upperBound) / 2);
            statusEl.innerHTML = `Gravação de <strong>${formattedTime}</strong> finalizada. Processando...`;
      }
    }

    async function processAudio() {
      processingStartTime = Date.now();
      const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
      loader.classList.remove('hidden');
      statusEl.classList.add('hidden');
      sendButton.disabled = true;
      startEstimationCountdown(estimatedProcessTime);
      try {
        const audioBase64 = await blobToBase64(audioBlob);
        await callGeminiAPI(audioBase64, 'audio/webm');
      } catch(err) {
        console.error("Erro ao processar o áudio ou chamar a API:", err);
        statusEl.textContent = `Erro no processamento: ${err.message}`;
        anamnesisEl.innerHTML = '<span class="placeholder">Falha ao gerar a anamnese. Verifique o console.</span>';
      } finally {
        loader.classList.add('hidden');
        statusEl.classList.remove('hidden');
        sendButton.disabled = false;
      }
    }

    // === LÓGICA DE CHAMADA À API E REFINAMENTO ===

    async function callGeminiAPI(audioBase64, mimeType) {
        const selectedPreset = specialtyPresets[selectedSpecialty];
        let sourceInstruction = '';

        if (selectedPreset && selectedPreset.sources.length > 0) {
            const sourceList = selectedPreset.sources.map(s => `- ${s}`).join('\n');
            sourceInstruction = `
            \n\n**DIRETRIZ ADICIONAL PARA SUGESTÕES E MELHORIAS:**
            Baseie suas sugestões de exames, prescrição e pontos de melhoria **prioritariamente** nas informações contidas na(s) fonte(s) mais relevante(s) da lista abaixo, que pertence ao contexto de "${selectedPreset.displayName}".
            
            **Fontes Confiáveis Pré-selecionadas:**
            ${sourceList}
            `;
        } else {
            sourceInstruction = `
            \n\n**DIRETRIZ ADICIONAL PARA SUGESTÕES E MELHORIAS:**
            Crie um plano terapêutico, sugestões de exames, prescrições e melhorias baseados nas diretrizes atuais de maior evidência científica para o caso apresentado.
            `;
        }
        
        let anamnesisFormat;
        if (anamnesisMethod === 'soap') {
            anamnesisFormat = `
            **Gere o prontuário usando estritamente o formato S.O.A.P.:**
            <strong>S (Subjetivo):</strong> Compile aqui tudo o que o paciente relata.
            <strong>O (Objetivo):</strong> Liste aqui apenas informações objetivas. Se não houver, indique "Nenhuma informação objetiva fornecida.".
            <strong>A (Avaliação):</strong> Apresente a(s) hipótese(s) diagnóstica(s) (HD).
            <strong>P (Plano):</strong> Descreva o plano de ação. Para cada item, adicione uma breve citação em linha, no formato (Fonte: Pág. X, Nome do Guia).
            <strong>Fonte do Plano:</strong> [OBRIGATÓRIO: Cite aqui a(s) fonte(s) COMPLETA(S) usada(s) para basear o plano terapêutico]
            `;
        } else { // Método Tradicional
            anamnesisFormat = `
            **Formato da Anamnese:**
            <strong>Identificação do Paciente:</strong>
            <strong>Queixa Principal (QP):</strong>
            <strong>História da Doença Atual (HDA):</strong>
            <strong>Revisão de Sistemas:</strong>
            <strong>História Médica Pregressa (HMP):</strong>
            <strong>História Familiar (HF):</strong>
            <strong>História Social e Hábitos de Vida (HSHV):</strong>
            <strong>Hipóteses Diagnósticas (HD):</strong>
            <strong>Plano Terapêutico Sugerido:</strong> Para cada item do plano, adicione uma breve citação em linha, no formato (Fonte: Pág. X, Nome do Guia).
            <strong>Fonte da Sugestão Terapêutica:</strong> [OBRIGATÓRIO: Cite aqui a(s) fonte(s) COMPLETA(S) usada(s) para basear o plano terapêutico]
            `;
        }

        let initialPromptInstruction;
        if (isConsultationComplete && originalTranscriptionText) {
            initialPromptInstruction = `
            Você é um assistente médico que está atualizando uma consulta em andamento.
            Abaixo está a transcrição da **primeira parte** da consulta.
            --- TRANSCRIÇÃO ANTERIOR ---
            ${originalTranscriptionText}
            --- FIM DA TRANSCRIÇÃO ANTERIOR ---
            
            Sua tarefa é analisar o **novo áudio** fornecido e **integrar as novas informações** com os dados da transcrição anterior para gerar um conjunto de documentos **COMPLETO e ATUALIZADO**.
            Você deve gerar UMA nova transcrição (combinando o antigo com o novo) e UMA nova anamnese e sugestões (com base em todas as informações combinadas).
            Siga as tarefas abaixo, usando os separadores exatos fornecidos:
            `;
        } else {
            initialPromptInstruction = `
            Você é um assistente médico altamente qualificado. Sua tarefa é analisar o áudio de uma consulta médica.
            Execute as seguintes tarefas, em ordem, usando os separadores exatos fornecidos:
            `;
        }


        const prompt = `
          ${initialPromptInstruction}

          1.  **Transcrever a Conversa:**
              * Transcreva a conversa na íntegra, identificando <strong>Doutor:</strong> e <strong>Paciente:</strong>. Se estiver atualizando, combine a transcrição anterior com a nova de forma coesa.
              * Apresente a transcrição completa sob o título "--- TRANSCRIÇÃO ---".

          2.  **Estruturar a Anamnese/Prontuário:**
              * Com base na transcrição **completa**, estruture um prontuário médico completo e profissional, seguindo o formato solicitado.
              * Apresente o prontuário sob o título "--- ANAMNESE ESTRUTURADA ---".

          3.  **Sugerir Exames Laboratoriais e de Imagem:**
              * Com base **exclusivamente** na(s) fonte(s) de referência, sugira exames relevantes.
              * **Após CADA exame**, cite a fonte em linha (ex: (Fonte: CAB nº37, Pág. 25)).
              * Ao final da lista, adicione "<strong>Fontes das Sugestões de Exames:</strong>" e liste a(s) fonte(s) completa(s).
              * Se nenhum exame for indicado pelas fontes, escreva "Nenhum exame específico sugerido com base nas fontes." e, na linha de fontes, adicione "<strong>Fontes das Sugestões de Exames:</strong> Nenhuma fonte aplicável.".
              * Apresente sob o título "--- SUGESTAO DE EXAMES ---".

          4.  **Sugerir Prescrição de Medicamentos:**
              * A **escolha do medicamento** deve ser baseada **exclusivamente** na(s) fonte(s) de referência.
              * Para cada medicamento, forneça: <strong>Nome do Medicamento</strong>, <strong>Posologia</strong>, <strong>Modo de Uso</strong> e <strong>Tempo de Tratamento</strong>.
              * **Após CADA prescrição**, cite a fonte que embasou a *escolha* do fármaco (ex: (Fonte: CAB nº36, Pág. 40)).
              * Ao final da lista, adicione "<strong>Fontes das Sugestões de Prescrição:</strong>" e liste a(s) fonte(s) completa(s).
              * Se nenhuma prescrição for indicada pelas fontes, escreva "Nenhuma prescrição específica sugerida com base nas fontes." e, na linha de fontes, adicione "<strong>Fontes das Sugestões de Prescrição:</strong> Nenhuma fonte aplicável.".
              * Apresente sob o título "--- SUGESTAO DE PRESCRICAO ---".

          5.  **Analisar Pontos de Melhoria:**
              * Com base **exclusivamente** na lista de fontes de referência, analise a transcrição e identifique tópicos ou perguntas que o médico **não abordou**, mas que seriam relevantes.
              * Liste cada ponto em formato de tópico (usando hífens).
              * **Após CADA item**, adicione uma breve citação em linha, no formato (Fonte: Pág. X, Nome do Guia).
              * Ao final de todos os pontos, adicione "<strong>Fontes das Sugestões de Melhoria:</strong>" e liste a(s) referência(s) completa(s).
              * Se nenhuma melhoria for identificada, escreva "Nenhum ponto de melhoria específico foi identificado com base nas informações fornecidas." e, na linha de fontes, adicione "<strong>Fontes das Sugestões de Melhoria:</strong> Nenhuma fonte aplicável.".
              * Apresente esta análise sob o título "--- PONTOS DE MELHORIA ---".

          **REGRAS DE FORMATAÇÃO (MUITO IMPORTANTE):**
          * **Negrito:** Use exclusivamente a tag HTML <strong>Negrito</strong>. **NUNCA** use asteriscos (**).
          * **Estrutura:** Organize o texto de forma clara, com parágrafos bem definidos.
          * **Seções Vazias:** Se uma seção não tiver informações, escreva "Nenhuma informação fornecida na consulta.".
          
          ${anamnesisFormat}
          ${sourceInstruction}
          `;
        
        const body = {"contents": [{"parts": [ { "text": prompt }, { "inline_data": { "mime_type": mimeType, "data": audioBase64 } }]}], "generationConfig": { "temperature": 0.4, "maxOutputTokens": 8192 }};
        
        try {
            const resp = await fetch(ENDPOINT, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
            if (!resp.ok) throw new Error(`HTTP ${resp.status}: ${await resp.text()}`);
            
            const data = await resp.json();
            const fullResponse = extractText(data);
            
            const transcriptionText = (fullResponse.split('--- ANAMNESE ESTRUTURADA ---')[0] || '').replace('--- TRANSCRIÇÃO ---', '').trim();
            const anamnesisText = (fullResponse.split('--- ANAMNESE ESTRUTURADA ---')[1] || '').split('--- SUGESTAO DE EXAMES ---')[0] || 'O modelo não retornou uma anamnese.';
            const examsText = (fullResponse.split('--- SUGESTAO DE EXAMES ---')[1] || '').split('--- SUGESTAO DE PRESCRICAO ---')[0] || 'Nenhuma sugestão de exame.';
            const prescriptionText = (fullResponse.split('--- SUGESTAO DE PRESCRICAO ---')[1] || '').split('--- PONTOS DE MELHORIA ---')[0] || 'Nenhuma sugestão de prescrição.';
            const improvementsText = (fullResponse.split('--- PONTOS DE MELHORIA ---')[1] || 'Nenhum ponto de melhoria identificado.').trim();
            
            originalTranscriptionText = transcriptionText;
            transcriptionEl.innerHTML = transcriptionText || 'Não foi possível extrair a transcrição.';
            anamnesisEl.innerHTML = anamnesisText.trim();
            examsSuggestionsEl.innerHTML = examsText.trim();
            prescriptionSuggestionsEl.innerHTML = prescriptionText.trim();
            improvementsEl.innerHTML = improvementsText;
            
            refineSection.classList.remove('hidden');
            improvementSection.classList.remove('hidden');
            examsSection.classList.remove('hidden');
            prescriptionSection.classList.remove('hidden');

            const processingTime = ((Date.now() - processingStartTime) / 1000).toFixed(1);
            statusEl.textContent = `Processo concluído em ${processingTime} segundos! Pronto para revisão.`;

            isConsultationComplete = true;
            stopEstimationCountdown();
            updateButtonsUI();


        } catch (err) {
            console.error("Erro na chamada da API:", err);
            statusEl.textContent = `Erro ao comunicar com a API do Gemini.`;
            anamnesisEl.innerHTML = '<span class="placeholder">Falha ao gerar a anamnese.</span>';
            isConsultationComplete = false;
            stopEstimationCountdown();
            updateButtonsUI();
        }
    }

    async function handleRefinement() {
        const corrections = correctionsTextarea.value.trim();
        if (!corrections) {
            alert("Por favor, insira as correções ou adições na caixa de texto antes de refazer o prontuário.");
            return;
        }

        refineButton.disabled = true;
        refineButton.textContent = "Refazendo...";
        statusEl.textContent = "Reanalisando com as correções...";
        refineStatusEl.textContent = '';

        let countdown = 10;
        refineStatusEl.textContent = `Estimativa: ${countdown}s`;
        const refineInterval = setInterval(() => {
            countdown--;
            if (countdown > 0) {
                refineStatusEl.textContent = `Estimativa: ${countdown}s`;
            } else {
                clearInterval(refineInterval);
                refineStatusEl.textContent = "Finalizando a reanálise...";
            }
        }, 1000);

        const selectedPreset = specialtyPresets[selectedSpecialty];
        let sourceInstruction = '';

        if (selectedPreset && selectedPreset.sources.length > 0) {
            const sourceList = selectedPreset.sources.map(s => `- ${s}`).join('\n');
            sourceInstruction = `
            \n\n**DIRETRIZ DE REFINAMENTO PARA SUGESTÕES E MELHORIAS:**
            Ao refazer as sugestões e melhorias, analise e utilize prioritariamente a(s) fonte(s) mais relevante(s) da lista abaixo, que pertence ao contexto de "${selectedPreset.displayName}".
            
            **Fontes Confiáveis Pré-selecionadas:**
            ${sourceList}
            `;
        } else {
            sourceInstruction = `
            \n\n**DIRETRIZ DE REFINAMENTO PARA SUGESTÕES E MELHORIAS:**
            Ao refazer as sugestões e melhorias, adicione condutas baseadas no maior grau de evidência científica atual sobre o assunto da consulta.
            `;
        }

        let anamnesisFormat;
        if (anamnesisMethod === 'soap') {
             anamnesisFormat = `
            **Refaça o prontuário usando estritamente o formato S.O.A.P.:**
            <strong>S (Subjetivo):</strong> Compile aqui tudo o que o paciente relata.
            <strong>O (Objetivo):</strong> Liste aqui apenas informações objetivas. Se não houver, indique "Nenhuma informação objetiva fornecida.".
            <strong>A (Avaliação):</strong> Apresente a(s) hipótese(s) diagnóstica(s) (HD).
            <strong>P (Plano):</strong> Descreva o plano de ação. Para cada item, adicione uma breve citação em linha, no formato (Fonte: Pág. X, Nome do Guia).
            <strong>Fonte do Plano:</strong> [OBRIGATÓRIO: Cite aqui a(s) fonte(s) COMPLETA(S) usada(s) para basear o plano terapêutico]
            `;
        } else { // Método Tradicional
             anamnesisFormat = `
            **Gere a anamnese usando o seguinte formato:**
            <strong>Identificação do Paciente:</strong>
            <strong>Queixa Principal (QP):</strong>
            <strong>História da Doença Atual (HDA):</strong>
            <strong>Revisão de Sistemas:</strong>
            <strong>História Médica Pregressa (HMP):</strong>
            <strong>História Familiar (HF):</strong>
            <strong>História Social e Hábitos de Vida (HSHV):</strong>
            <strong>Hipóteses Diagnósticas (HD):</strong>
            <strong>Plano Terapêutico Sugerido:</strong> Para cada item do plano, adicione uma breve citação em linha, no formato (Fonte: Pág. X, Nome do Guia).
            <strong>Fonte da Sugestão Terapêutica:</strong> [OBRIGATÓRIO: Cite aqui a(s) fonte(s) COMPLETA(S) usada(s) para basear o plano terapêutico]
            `;
        }

        const prompt = `
        Você é um assistente médico especialista. Sua tarefa é refazer um prontuário médico completo com base em correções.
        Abaixo estão a transcrição ORIGINAL de uma consulta e as CORREÇÕES manuais feitas por um profissional.
        Sua missão é gerar um NOVO conjunto de documentos (prontuário, sugestões de exames, prescrição e melhorias), combinando as informações de ambas as fontes para garantir máxima precisão.

        --- TRANSCRIÇÃO ORIGINAL ---
        ${originalTranscriptionText}

        --- CORREÇÕES E ADIÇÕES DO PROFISSIONAL ---
        ${corrections}

        --- FIM DAS INFORMAÇÕES ---

        **SUA TAREFA FINAL (em quatro partes):**
        Use as informações combinadas para gerar o seguinte, na ordem exata e com os separadores:

        1.  **Gerar o Prontuário Corrigido**: Crie o prontuário final no formato solicitado, incorporando as correções. Apresente o prontuário e DEPOIS use o separador "--- SUGESTAO DE EXAMES ---".

        2.  **Sugerir Exames (Corrigido)**:
            * Com base **exclusivamente** na(s) fonte(s) de referência, sugira exames relevantes para o caso corrigido.
            * **Após CADA exame**, cite a fonte em linha (ex: (Fonte: CAB nº37, Pág. 25)).
            * Ao final da lista, adicione "<strong>Fontes das Sugestões de Exames:</strong>" e liste a(s) fonte(s) completa(s).
            * Se nenhum exame for indicado, escreva "Nenhum exame específico sugerido com base nas fontes." e adicione "<strong>Fontes das Sugestões de Exames:</strong> Nenhuma fonte aplicável.".
            * Apresente esta seção e DEPOIS use o separador "--- SUGESTAO DE PRESCRICAO ---".

        3.  **Sugerir Prescrição (Corrigido)**:
            * A **escolha do medicamento** deve ser baseada **exclusivamente** na(s) fonte(s) de referência para o caso corrigido.
            * Forneça: <strong>Nome do Medicamento</strong>, <strong>Posologia</strong>, <strong>Modo de Uso</strong> e <strong>Tempo de Tratamento</strong>.
            * **Após CADA prescrição**, cite a fonte que embasou a *escolha* do fármaco (ex: (Fonte: CAB nº36, Pág. 40)).
            * Ao final, adicione "<strong>Fontes das Sugestões de Prescrição:</strong>" e liste a(s) fonte(s) completa(s).
            * Se nenhuma prescrição for indicada, escreva "Nenhuma prescrição específica sugerida com base nas fontes." e adicione "<strong>Fontes das Sugestões de Prescrição:</strong> Nenhuma fonte aplicável.".
            * Apresente esta seção e DEPOIS use o separador "--- PONTOS DE MELHORIA ---".

        4.  **Analisar Pontos de Melhoria (Corrigido)**:
            * Com base **exclusivamente** na lista de fontes de referência, identifique o que **faltou ser perguntado** na consulta, considerando as informações corrigidas.
            * **Após CADA item**, adicione a citação em linha (Fonte: Pág. X, Nome do Guia).
            * Ao final, adicione "<strong>Fontes das Sugestões de Melhoria:</strong>" e liste a(s) referência(s) completa(s).
            * Se nenhuma melhoria for identificada, escreva "Nenhum ponto de melhoria específico foi identificado." e adicione "<strong>Fontes das Sugestões de Melhoria:</strong> Nenhuma fonte aplicável.".

        **REGRAS DE FORMATAÇÃO (MUITO IMPORTANTE):**
        * **Negrito:** Use exclusivamente a tag HTML <strong>Negrito</strong>. **NUNCA** use asteriscos (**).
        * **Estrutura:** Organize o texto de forma clara e com parágrafos bem definidos.
        * **Seções Vazias:** Se uma seção não tiver informações, escreva "Nenhuma informação fornecida na consulta.".

        ${anamnesisFormat}
        ${sourceInstruction}
        `;


        const body = {"contents": [{"parts": [{ "text": prompt }]}], "generationConfig": { "temperature": 0.3, "maxOutputTokens": 8192 }};

        try {
            const resp = await fetch(ENDPOINT, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
            if (!resp.ok) throw new Error(`HTTP ${resp.status}: ${await resp.text()}`);
            
            const data = await resp.json();
            const fullResponse = extractText(data);
            
            const newAnamnesis = (fullResponse.split('--- SUGESTAO DE EXAMES ---')[0] || 'O modelo não retornou um prontuário refeito.').trim();
            const newExams = (fullResponse.split('--- SUGESTAO DE EXAMES ---')[1] || '').split('--- SUGESTAO DE PRESCRICAO ---')[0] || 'Nenhuma sugestão de exame reanalisada.';
            const newPrescriptions = (fullResponse.split('--- SUGESTAO DE PRESCRICAO ---')[1] || '').split('--- PONTOS DE MELHORIA ---')[0] || 'Nenhuma sugestão de prescrição reanalisada.';
            const newImprovements = (fullResponse.split('--- PONTOS DE MELHORIA ---')[1] || 'Nenhum ponto de melhoria identificado na reanálise.').trim();

            anamnesisEl.innerHTML = newAnamnesis;
            examsSuggestionsEl.innerHTML = newExams.trim();
            prescriptionSuggestionsEl.innerHTML = newPrescriptions.trim();
            improvementsEl.innerHTML = newImprovements;
            statusEl.textContent = "Prontuário e sugestões refeitos com sucesso a partir das suas correções!";

        } catch (err) {
            console.error("Erro ao refazer anamnese:", err);
            statusEl.textContent = `Erro ao refazer o prontuário.`;
        } finally {
            clearInterval(refineInterval);
            refineStatusEl.textContent = '';
            refineButton.disabled = false;
            refineButton.textContent = "Refazer Prontuário com Correções";
        }
    }


    // === FUNÇÕES AUXILIARES ===
    function blobToBase64(blob) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result.split(',')[1]);
        reader.onerror = reject;
        reader.readAsDataURL(blob);
      });
    }
    function extractText(json) {
        try { return json.candidates[0].content.parts[0].text; } 
        catch (e) { console.error('Erro no parse da resposta da API', e, json); return 'Erro ao extrair texto da resposta.'; }
    }
    
    // [FUNÇÃO ALTERADA] para gerenciar o novo estado e o botão de reset
    function updateButtonsUI() {
        if (!isRecording) {
            // Não está gravando
            recordButton.classList.remove('hidden');
            pauseButton.classList.add('hidden');
            resumeButton.classList.add('hidden');
            sendButton.classList.add('hidden');
            
            // Lógica para mostrar/esconder o botão de reset
            if (isConsultationComplete) {
                resetButton.classList.remove('hidden');
                recordButton.querySelector('span').textContent = 'Gravar Adicional'; // Muda o texto do botão
            } else {
                resetButton.classList.add('hidden');
                recordButton.querySelector('span').textContent = 'Gravar Consulta'; // Garante o texto original
            }
        } else {
            // Está gravando
            recordButton.classList.add('hidden');
            resetButton.classList.add('hidden');
            sendButton.classList.remove('hidden');
            
            if (isPaused) {
                pauseButton.classList.add('hidden');
                resumeButton.classList.remove('hidden');
            } else {
                pauseButton.classList.remove('hidden');
                resumeButton.classList.add('hidden');
            }
        }
    }
  })();
  </script>
</body>
</html>
